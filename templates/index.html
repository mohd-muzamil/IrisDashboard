<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Iris-UseCase</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="https://code.jquery.com/ui/1.12.1/themes/ui-lightness/jquery-ui.css" rel="stylesheet" />
    <link href="../css/style.css" rel="stylesheet">
    <link href="../css/parallelCordMBostock.css" rel="stylesheet">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css'>
</head>

<body>
    </script>
    <!-- load bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
    <!-- load jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <!-- load jQuery UI -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- load libraries for multiselect dropdown -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>
    <!-- multi select -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/1.1.1/js/bootstrap-multiselect.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/1.1.1/css/bootstrap-multiselect.css">
    <!-- toggle switch -->
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>

    <div class="container-fluid m-0 p-0" style="height:100%">
        <div class="row flex-nowrap" style="height:100%">
            <!-- sidebar -->
            <div class="col-auto p-0 ml-3">
                <div id="sidebar" class="card collapse collapse-horizontal show">
                    <!-- show is used here to hide or show the sidebar by default-->
                    <div id="sidebar-nav" class="list-group border-0 rounded-0 text-sm-start min-vh-100">
                        <img src="../img/iris.png" alt="Iris" style="display: block; margin-top:20px; margin-left:auto; margin-right: auto; width: 30%;">
                        <h6 id="dashboardHeader" style="margin:0; padding: 0; text-align:center; color:rgb(18, 113, 249)">Iris Dataset</h6>
                        <br><hr class="double">

                        <div class="card m-0 p-0 py-2" style="display:flex; text-align: left;">
                            <!-- multi select dropdown -->
                            <div class="container m-0 p-0" style="display:inline; text-align: left; font-size: 13px;">
                                <span class="pl-1" onclick=alertFeatureSelection()><i class="fa-solid fa-circle-question"></i></span>
                                <label class="pl-2" style="font-size: 13px; font-weight:500; ">Feature Selection</label>
                                <div class="row m-0 p-0">
                                    <div class="col-10 mr-0 pr-0 pl-1">
                                        <select id="featureSelect" multiple>
                                        <option value="sepal_length" selected="selected">Sepal Length</option>
                                        <option value="sepal_width" selected="selected">Sepal Width</option>
                                        <option value="petal_length" selected="selected">Petal Length</option>
                                        <option value="petal_width" selected="selected">Petal Width</option>
                                    </select>
                                    </div>
                                    <div class="col-2 m-0 p-0 pt-2">
                                        <button class="button" id="btn-featureSelection">
                                        <i class="fa fa-square-check"></i>
                                    </button>
                                    </div>
                                </div>
                            </div>
                            <br><hr>

                            <!-- k-param -->
                            <div class="container m-0 p-0" style="display:inline-block; text-align: left; font-size: 13px;">
                                <span class="pl-1" onclick=alertKparam()><i class="fa-solid fa-circle-question"></i></span>
                                <label class="pl-2" style="font-size: 13px; font-weight:500; "> K param for KNN</label>
                                <div class="row m-0 p-0">
                                    <div class="col-10 num-block skin-1 m-0 p-0 pl-2">
                                        <div class="num-in">
                                            <span class="minus"></span>
                                            <input style="font-weight:bold; font-size: 13px" type="text" class="in-num" value="3">
                                            <span class="plus"></span>
                                        </div>
                                    </div>
                                    <div class="col-2 m-0 p-0">
                                        <button class="button" id="btn-knn">
                                        <i class="fa fa-square-check"></i>
                                    </button>
                                    </div>
                                </div>
                            </div>
                            <br><hr>

                            <!-- Toggle Dimensionality Reduction technique tsne/pca -->
                            <div class="container m-0 p-0" style="display:inline; text-align: left; font-size: 13px;">
                                <span style="font-size: 13px; text-align: left;" onclick=alertDimRedux()><i class="fa-solid fa-circle-question"></i></span>
                                <label class="form-check-label" for="toggleDimRedux" style="font-size: 13px; font-weight:500; ">2-D projection</label>
                                <div class="row m-0 p-0">
                                    <div class="col-10 m-0 p-0 pl-2 pt-1">
                                        <input class="pl-3" type="checkbox" checked data-toggle="toggle" data-style="round" data-size="xs" data-width=80 data-on="PCA" data-off="t-SNE" id="toggleDimRedux">
                                    </div>
                                    <div class="col-2 m-0 p-0 pt-1">
                                        <button class="button" id="btn-toggleDimRedux">
                                            <i class="fa fa-square-check"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <br><hr>
                            
                            
                            <!-- slider for radius of glyph -->
                            <div class="container m-0 p-0" style="display:inline; text-align: left; font-size: 13px;">
                                <span class="pl-1" onclick=alertGlyphRadius()><i class="fa-solid fa-circle-question"></i></span>
                                <label class="pl-2" style="font-size: 13px; font-weight:500; ">Glyph Radius : </label>
                                <span style="font-weight:bold" id="sliderVal"></span>
                                <div class="row m-0 p-0">
                                    <div class="col-10 m-0 p-0 pl-2">
                                        <input type="range" min="10" max="20" value="15" steps='1' class="slider" id="myRange">
                                    </div>
                                    <div class="col-2 m-0 p-0">
                                        <button class="button" id="btn-glyphRadius">
                                            <i class="fa fa-square-check"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="double">


                        <div class="card m-0 p-0 py-2" style="display:flex; text-align: left;">
                            <br>
                            <!-- Toggle glyph switch -->
                            <div class="form-check form-switch pl-1" style="text-align: left">
                                <span style="font-size: 13px; text-align: left;" onclick=alertGlyph()><i class="fa-solid fa-circle-question"></i></span>
                                <input class="pl-3" type="checkbox" checked data-toggle="toggle" data-style="round" data-size="xs" data-width=80 data-on="Flower" data-off="Radial" id="toggleGlyph">
                                <label class="form-check-label" for="toggleGlyph" style="font-size: 13px; font-weight:500; ">Glyph</label>
                            </div>
                            <br><hr>

                            <!-- Toggle Overlap removal -->
                            <div class="form-check form-switch pl-1" style="text-align: left">
                                <span style="font-size: 13px; text-align: left;" onclick=alertOverlap()><i class="fa-solid fa-circle-question"></i></span>
                                <input class="pl-3" type="checkbox" checked data-toggle="toggle" data-style="round" data-size="xs" data-width=80 data-on="Remove" data-off="Keep" id="toggleDGrid">
                                <label class="form-check-label" for="toggleDGrid" style="font-size: 13px; font-weight:500; ">Overlap</label>
                            </div>
                            <br><hr>

                            <!-- Show labels switch -->
                            <div class="form-check form-switch pl-1" style="text-align: left">
                                <span style="font-size: 13px; text-align: left;" onclick=alertLabels()><i class="fa-solid fa-circle-question"></i></span>
                                <input class="pl-3" type="checkbox" checked data-toggle="toggle" data-style="round" data-size="xs" data-width=80 data-on="Show" data-off="Hide" id="toggleLabels">
                                <label class="form-check-label" for="toggleLabels" style="font-size: 13px; font-weight:500; ">Labels</label>
                            </div>
                            <br><hr>

                            <!-- Show grid switch -->
                            <div class="form-check form-switch pl-1" style="text-align: left">
                                <span style="font-size: 13px; text-align: left;" onclick=alertGrid()><i class="fa-solid fa-circle-question"></i></span>
                                <input class="pl-3" type="checkbox" checked data-toggle="toggle" data-style="round" data-size="xs" data-width=80 data-on="Show" data-off="Hide" id="toggleSvgGrid">
                                <label class="form-check-label" for="toggleSvgGrid" style="font-size: 13px; font-weight:500; ">Grid</label>
                            </div>
                        </div>
                        <hr class="double">
                    </div>
                </div>
            </div>

            <!-- main -->
            <main class="col my-1 pl-1">
                <div id="dashboard">
                    <svg class="svg1" id="chart1"></svg>
                    <svg class="svg2" id="chart2"></svg>
                    <a data-toggle="collapse" href="#" data-target="#sidebar" aria-expanded="false" id="menu">Menu</a>
                </div>
            </main>
        </div>
    </div>

    <script>
        //settings for multiselect dropdown - run at the begining of page refresh/first load
        $('#featureSelect').multiselect({
            enableClickableOptGroups: true,
            enableCollapsibleOptGroups: true,
            enableFiltering: true,
            filterPlaceholder: 'Search',
            includeSelectAllOption: true,
            buttonWidth: '140px',
            maxHeight: screen.height * 0.6,
            // buttonClass: 'btn btn-link',
            numberDisplayed: 1
        })

        $('#toggleDimRedux').bootstrapToggle('off')
        $('#toggleLabels').bootstrapToggle('off')
    </script>

    <!-- Imports -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https:/d3js.org/d3-scale-chromatic.v0.3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
    <script src="../js/d3-lasso.min.js"></script>

    <!-- PROSIT Charts -->
    <!-- glyphs scatter plot : svg1 -->
    <script src="../js/glyphs.js"></script>
    <!-- parallel cordinate chart : svg2 -->
    <script src="../js/parallelCoordinateChart.js"></script>
    <!-- loading symbol during buffer -->
    <script src="../js/buffering.js"></script>
    <script>
        // config
        var glyphsChart = "chart1"
        var parallelCordChart = "chart2"
        var ids
        var selectedId
        var featurelist = $('#featureSelect').val()
        var radius = +document.getElementById("myRange").value
        var k
        var toggleGlyph //'radialGlyph' for radialGlyph glyph and 'flowerGlyph' for flowerGlyph glyph
        var toggleDimRedux
        var toggleDGrid
        var toggleLabels //true for showing labels
        var toggleSvgGrid //true for showing the grid
        var delayInMilliseconds = 500

        // jquery handlers for initially setting the values of variables
        {
            if ($("#toggleGlyph").is(':checked')) {
                toggleGlyph = "flowerGlyph"
            } else {
                toggleGlyph = "radialGlyph"
            }

            if ($("#toggleDimRedux").is(':checked')) {
                toggleDimRedux = "pca"
            } else {
                toggleDimRedux = "tsne"
            }

            if ($("#toggleDGrid").is(':checked')) {
                toggleDGrid = true
            } else {
                toggleDGrid = false
            }

            if ($("#toggleLabels").is(':checked')) {
                toggleLabels = true
            } else {
                toggleLabels = false
            }

            if ($("#toggleSvgGrid").is(':checked')) {
                toggleSvgGrid = true
            } else {
                toggleSvgGrid = false
            }
            
            k = $('.num-in span').parents('.num-block').find('input.in-num').val()
            toggleDimRedux = "tsne"
            toggleDGrid = true

            //number spinner for knn param +/-
            $(document).ready(function() {
                const min = 1
                const max = ids.length
                k = $('.num-in span').parents('.num-block').find('input.in-num').val()
                $('.num-in span').click(function() {
                    var $input = $(this).parents('.num-block').find('input.in-num')
                    if ($(this).hasClass('minus')) {
                        var count = parseFloat($input.val()) - 1
                        count = count < min ? 1 : count
                        if (count == min) {
                            $(this).addClass('dis')
                        } else {
                            $(this).removeClass('dis')
                        }
                        $input.val(count)
                    } else {
                        var count = parseFloat($input.val()) + 1
                        count = count > max ? max : count
                        $input.val(count)
                        if (count == max) {
                            $(this).parents('.num-block').find(('.minus')).removeClass('dis')
                        }
                    }
                    $input.change()
                    return false
                })
            })

            // jquery handlers for showing chart for random data on screen
        {
            // set a  ramdom value to select an id 
            $.ajax({
                type: "GET",
                async: false,
                url: "/getIds",
                success: function(response) {
                    ids = response
                    selectedId = ids[Math.floor(Math.random() * ids.length)]
                }
            })
            process()
            renderChartsPCP()
        }

            // auto update the button for k param when input goes above the range
            $('.num-in span').parents('.num-block').find('input.in-num').on("change", () => {
                k = $('.num-in span').parents('.num-block').find('input.in-num').val()
                if (k < 1) {
                    $('.num-in span').parents('.num-block').find('input.in-num').val(1)
                } else if (k > 150) {
                    $('.num-in span').parents('.num-block').find('input.in-num').val(150)
                }
                k = $('.num-in span').parents('.num-block').find('input.in-num').val()
            })
        }

        // jquery handlers for regreshing charts after resizing
        {
            // auto refresh after window resizing
            jQuery(function($) {
                var windowWidth = $(window).width()
                var windowHeight = $(window).height()
                var id
                $(window).resize(function() {
                    clearTimeout(id)
                    id = setTimeout(doneResizing, 500)
                })

                function doneResizing() {
                    if (windowWidth != $(window).width() || windowHeight != $(window).height()) {
                        location.reload()
                        return
                    }
                }
            })

            // refresh after the side open or close using menu click event
            var a = document.getElementById("menu")
            a.addEventListener("click", function() {
                renderChartsGlyphs(500)
            }, false)

        }

        // jquery handlers for the input types in the Menu
        {
            //range slider 
            var slider = document.getElementById("myRange")
            var output = document.getElementById("sliderVal")
            output.innerHTML = slider.value
            slider.oninput = function() {
                radius = this.value
                output.innerHTML = radius
            }

            // switch to select glyphs
            $("#toggleGlyph").on('change', function() {
                if ($(this).is(':checked')) {
                    toggleGlyph = "flowerGlyph"
                } else {
                    toggleGlyph = "radialGlyph"
                }
                // console.log("toggleGlyph: ", toggleGlyph)
                renderChartsGlyphs()
            })

            // switch to select the type of dimensionality reduction
            $("#toggleDimRedux").on('change', function() {
                if ($(this).is(':checked')) {
                    toggleDimRedux = "pca"
                } 
                else toggleDimRedux = "tsne"
            })

            // switch to use DGrid to remove overlap over the glyphs
            $("#toggleDGrid").on('change', function() {
                if ($(this).is(':checked')) {
                    toggleDGrid = true
                } else {
                    toggleDGrid = false
                }
                // console.log("toggleDGrid: ", toggleDGrid)
                renderChartsGlyphs()
            })

            // switch to show or hide labels
            $("#toggleLabels").on('change', function() {
                if ($(this).is(':checked')) {
                    toggleLabels = true
                } else {
                    toggleLabels = false
                }
                // console.log("toggleLabels: ", toggleLabels)
                renderChartsGlyphs()
            })

            // switch to show or hide grid
            $("#toggleSvgGrid").on('change', function() {
                if ($(this).is(':checked')) {
                    toggleSvgGrid = true
                } else {
                    toggleSvgGrid = false
                }
                // console.log("toggleSvgGrid: ", toggleSvgGrid)
                renderChartsGlyphs()
            })

            // menu button click events
            $("#btn-featureSelection").click(function() {
                process(delayInMilliseconds)
                renderChartsPCP()
            })
            $("#btn-knn").click(function() {
                processKNN(delayInMilliseconds)
            })
            $("#btn-toggleDimRedux").click(function() {
                process(delayInMilliseconds)
            })
            $("#btn-glyphRadius").click(function() {
                process(delayInMilliseconds)
            })
        }

        // function to call the server route which computes the ML algorithms.
        function process(delay=delayInMilliseconds) {
            featurelist = $('#featureSelect').val()
            if(featurelist.length<2)
            {   
                alert("Please select more than one column in Feature selection drop down!!!")
            }
            else {
                w = Math.floor($('.svg1')[0].getBoundingClientRect().width)
                h = Math.floor($('.svg1')[0].getBoundingClientRect().height)
                var postForm = {
                    "featureColumns": featurelist,
                    "width": w,
                    "height": h,
                    "radius": radius,
                    "k": k,
                    "toggleDimRedux": toggleDimRedux
                }
                console.log(postForm)
                $.ajax({
                    type: "POST",
                    contentType: 'application/json',
                    data: JSON.stringify(postForm),
                    url: "/dimReduceIds",
                    success: function(status) {
                        if (status === "status1:fileUpdated") {
                            // console.log("FeatureData file updated")
                        }
                        else console.log("unknown status", status, "File has been reset using default values")
                    }
                })
            buffering(glyphsChart, selectedId, toggleText = false)
            renderChartsGlyphs(delay)
            //uncomment below line to hide the sidebar after submit button
            // $("#sidebar").removeClass("show")
            }
        }
        
        function processKNN(){
            postForm = { "featureColumns":featurelist, "k":k }
            if (featurelist.length<2){alert("Please select more than one column in Feature selection drop down!!!")}
            else {
                $.ajax({
                    type: "POST",
                    contentType: 'application/json',
                    data: JSON.stringify(postForm),
                    url: "/knnClustering",
                    async: false,
                    success: function(status) {
                        if (status === "status1:fileUpdated") {
                            // console.log("FeatureData file updated")
                            }
                        else console.log("unknown status", status, "File has been reset using default values")
                        renderChartsGlyphs()
                    }
                })
            }
        }

        // Funtion to plot the only glyph-view
        function renderChartsGlyphs(delay = 0) {
            $("body").css("cursor", "wait")
            //calling method that plots buffering symbol
            setTimeout(function() {
                //code to be executed after delay
                updateGlyphs(glyphsChart, parallelCordChart, selectedId, featurelist, radius, toggleGlyph, toggleDGrid, toggleLabels, toggleSvgGrid)
                $("body").css("cursor", "default")
            }, delay)
        }

        // Funtion to plot the glyph-view and PCP-view
        function renderChartsPCP(delay = 0) {
            //calling method that plots buffering symbol
            buffering(parallelCordChart, selectedId)

            setTimeout(function() {
                //code to be executed after delay
                updateParallelCord(parallelCordChart, selectedId, [], featurelist)
            }, delay)
        }

        {
        // alerts click on help button
        function alertFeatureSelection() {
            alert("Feature Selection")
        }

        function alertKparam() {
            alert("K param")
        }

        function alertDimRedux() {
            alert("Dimensionality Reduction")
        }

        function alertOverlap(){
            alert("Overlap removal")
        }

        function alertGlyphRadius() {
            alert("Glyph radius")
        }

        function alertGlyph() {
            alert("Glyph type")
        }

        function alertLabels() {
            alert("labels")
        }

        function alertGrid() {
            alert("Grid")
        }
    }
    </script>
</body>

</html>